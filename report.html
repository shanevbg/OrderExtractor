/**
 * Order Extractor - Report Logic
 * Version: 1.0.57
 */

function escapeHtml(text) {
    if (text === null || text === undefined) return "";
    return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

function copyToClip(encodedAddr, btn) {
    let rawAddr = decodeURIComponent(encodedAddr);
    navigator.clipboard.writeText(rawAddr).then(() => {
        let originalText = btn.textContent;
        btn.textContent = "Copied!";
        btn.classList.add("copied");
        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove("copied");
        }, 2000);
    }).catch(err => alert("Clipboard failed: " + err));
}

function deleteRow(btn) {
    let row = btn.closest("tr");
    if (row) row.remove();
}

function parseAddressForCSV(linesRaw) {
    let lines = [...linesRaw];
    let result = { name: "", address1: "", address2: "", city: "", state: "", zip: "", country: "", phone: "", email: "" };
    if (lines.length === 0) return result;

    lines = lines.filter(line => {
        let isPhone = /^(\+?\d[\d\-\s\(\)]{7,}\d)$/.test(line);
        let isEmail = /^[\w\.-]+@[\w\.-]+\.\w+$/.test(line);
        if (isPhone) result.phone = line;
        if (isEmail) result.email = line;
        return !isPhone && !isEmail;
    });

    if (lines.length > 0) result.name = lines.shift();
    if (lines.length > 0 && /United Kingdom|Canada|Australia|Puerto Rico|USA|United States/i.test(lines[lines.length - 1])) {
        result.country = lines.pop();
    } else {
        result.country = "United States";
    }

    if (lines.length > 0) {
        let last = lines[lines.length - 1];
        let cszMatch = last.match(/^(.*?)[,\s]+([A-Za-z]{2,3})[,\s]+([\d\w\-\s]{3,10})$/);
        if (cszMatch) {
            result.city = cszMatch[1].trim();
            result.state = cszMatch[2].trim();
            result.zip = cszMatch[3].trim();
            lines.pop();
        } else {
            result.city = last;
            lines.pop();
        }
    }

    if (lines.length > 0) result.address1 = lines.shift();
    if (lines.length > 0) result.address2 = lines.join(", ");
    return result;
}

function exportToCSV(data) {
    if (!data || data.length === 0) return;
    let csvContent = "Order ID,Order Date,Full Name,Address 1,Address 2,City,State,Zip Code,Country,Phone,Email,Notes,Item Title\n";
    const q = (str) => `"${String(str || '').replace(/"/g, '""')}"`;

    data.forEach(item => {
        let addr = parseAddressForCSV(item.addressLines || []);
        let row = [
            q(item.order), q(item.dateStr), q(addr.name), q(addr.address1), q(addr.address2),
            q(addr.city), q(addr.state), q(addr.zip), q(addr.country), q(addr.phone), q(addr.email),
            q(item.notes), q(item.product)
        ];
        csvContent += row.join(",") + "\n";
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "stamps_import.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function composeReportEmail(data) {
    let senders = [];
    data.forEach(item => {
        if (item.sender && item.sender.includes("@") && !senders.includes(item.sender)) {
            senders.push(item.sender);
        }
    });

    let targetEmail = senders.length > 0 ? senders[0] : "";
    if (!targetEmail) alert("No sender email found. 'To' field will be empty.");

    // Clone the table to manipulate it for email without breaking the view
    let originalTable = document.getElementById("orderTable");
    let emailTable = originalTable.cloneNode(true);

    // CLEANUP THE CLONE
    // 1. Remove Actions Column (Header and Body)
    let headerRow = emailTable.querySelector("thead tr");
    if (headerRow && headerRow.lastElementChild.innerText === "Actions") {
        headerRow.lastElementChild.remove();
    }
    
    emailTable.querySelectorAll("tbody tr").forEach(tr => {
        // Remove Action Cell
        if (tr.lastElementChild) tr.lastElementChild.remove();
        
        // Remove "Copy Address" Button from Address Cell
        let addrCell = tr.children[2];
        let copyBtn = addrCell.querySelector(".copy-btn");
        if (copyBtn) copyBtn.remove();

        // CONVERT NAME LINK -> EBAY URL OR GMAIL SEARCH
        let nameLink = addrCell.querySelector(".name-link");
        if (nameLink) {
            let name = nameLink.innerText.trim();
            let rowId = nameLink.getAttribute("data-msgid");
            let dataItem = data.find(d => d.messageId == rowId);
            
            let finalUrl = "#";

            // LOGIC: Check Source Type
            if (dataItem && dataItem.source === "ebay" && dataItem.order !== "Unknown") {
                // Direct Link to eBay Seller Hub Order Details
                finalUrl = "https://www.ebay.com/sh/ord/details?orderid=" + dataItem.order;
            } 
            else if (dataItem && dataItem.sender && dataItem.subject) {
                // Fallback: Gmail Search (WooCommerce, Manual, etc.)
                let query = encodeURIComponent("from:" + dataItem.sender + " subject:\"" + dataItem.subject + "\"");
                finalUrl = "https://mail.google.com/mail/u/0/#search/" + query;
            } 
            else {
                // Fallback: Name search
                finalUrl = "https://mail.google.com/mail/u/0/#search/" + encodeURIComponent(name);
            }

            nameLink.href = finalUrl;
            nameLink.style.color = "#1a73e8";
            nameLink.style.textDecoration = "none";
            nameLink.style.fontWeight = "bold";
            // Clean up attributes
            nameLink.removeAttribute("class");
            nameLink.removeAttribute("data-msgid");
        }
    });

    // Inline CSS for the Table
    emailTable.setAttribute("border", "1");
    emailTable.setAttribute("cellpadding", "5");
    emailTable.style.borderCollapse = "collapse";
    emailTable.style.width = "100%";
    emailTable.style.fontSize = "12px";
    
    emailTable.querySelectorAll("th").forEach(th => {
        th.style.background = "#333";
        th.style.color = "#fff";
        th.style.textAlign = "left";
    });

    // Use Array join for safety (Avoids AI tool escaping issues)
    let htmlParts = [];
    htmlParts.push('<html><body style="font-family: Arial, sans-serif; color: #000;">');
    htmlParts.push('<h2>Order Summary Report</h2>');
    htmlParts.push('<p>Here is the extracted summary. Click a name to open the order (eBay) or search Gmail.</p><br>');
    htmlParts.push(emailTable.outerHTML);
    htmlParts.push('<br><p>Generated by Order Extractor</p>');
    htmlParts.push('</body></html>');

    browser.runtime.sendMessage({
        action: "compose_report",
        to: targetEmail,
        html: htmlParts.join("")
    });
}

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("reload-btn").addEventListener("click", () => location.reload());

    browser.storage.local.get("reportData").then((storage) => {
        let data = storage.reportData;
        let tbody = document.querySelector("tbody");
        tbody.innerHTML = ""; 

        let count = data ? data.length : 0;
        document.getElementById("footer-ver").textContent += " - Items Loaded: " + count;

        if (!data || data.length === 0) {
            tbody.innerHTML = "<tr><td colspan='6'>No data found. Please re-run extraction.</td></tr>";
            return;
        }

        document.getElementById("export-btn").addEventListener("click", () => exportToCSV(data));
        document.getElementById("email-btn").addEventListener("click", () => composeReportEmail(data));

        let orderCounts = {};
        data.forEach(item => {
            let num = item.order;
            orderCounts[num] = (orderCounts[num] || 0) + 1;
        });

        data.forEach((item) => {
            let safeOrder = escapeHtml(item.order);
            let safeProduct = escapeHtml(item.product);
            let safeNotes = escapeHtml(item.notes);
            let safeDate = escapeHtml(item.dateStr); 
            
            let addressDisplayHtml = "";
            if (item.addressLines && item.addressLines.length > 0) {
                let name = escapeHtml(item.addressLines[0]);
                let rest = item.addressLines.slice(1).map(escapeHtml).join("<br>");
                
                if (item.messageId) {
                    // Report Tab Link: Contains ONLY msgid for Thunderbird internal open
                    addressDisplayHtml = '<a class="name-link" href="#" data-msgid="' + item.messageId + '">' + name + '</a><br>' + rest;
                } else {
                    addressDisplayHtml = name + "<br>" + rest;
                }
            } else {
                addressDisplayHtml = item.address || "";
            }

            let rawAddress = (item.addressLines && Array.isArray(item.addressLines)) ? item.addressLines.join("\n") : "";
            let encodedAddress = encodeURIComponent(rawAddress);

            let orderClass = "";
            if (orderCounts[item.order] > 1) {
                orderClass = "duplicate-order";
            }

            let tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="${orderClass}">${safeOrder}</td>
                <td>${safeProduct}</td>
                <td>
                    <div>${addressDisplayHtml}</div>
                </td>
                <td class="notes-cell">${safeNotes}</td>
                <td>${safeDate}</td>
                <td style="text-align:center;"></td>
            `;

            let btnCopy = document.createElement("button");
            btnCopy.className = "copy-btn";
            btnCopy.textContent = "Copy Address";
            btnCopy.addEventListener("click", function() { copyToClip(encodedAddress, this); });
            tr.children[2].appendChild(btnCopy);

            let btnDel = document.createElement("button");
            btnDel.className = "del-btn";
            btnDel.textContent = "X";
            btnDel.title = "Remove this order";
            btnDel.addEventListener("click", function() { deleteRow(this); });
            tr.children[5].appendChild(btnDel);

            tbody.appendChild(tr);
        });

        // ROBUST CLICK LISTENER
        document.querySelector("tbody").addEventListener("click", (e) => {
            let link = e.target.closest(".name-link");
            if (link) {
                e.preventDefault();
                let msgId = parseInt(link.dataset.msgid);
                if (msgId) {
                    browser.runtime.sendMessage({ action: "open_message", id: msgId });
                }
            }
        });
    });
});